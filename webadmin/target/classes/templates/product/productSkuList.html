<html xmlns:th="http://www.thymeleaf.org">
<head th:include="base/common_head :: common_head">
</head>
<body>
<div th:include="base/common_js :: common_js"></div>
<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
    <legend>物品管理</legend>
</fieldset>
<div class="layui-row">
    <div class="layui-col-md8">
        <div class="grid-demo grid-demo-bg1">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">商品名称</label>
                    <div class="layui-input-inline">
                        <input type="tel" name="phone" lay-verify="required|phone" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <button class="layui-btn layui-btn-normal">搜索</button>
            </div>
        </div>
    </div>
    <div class="layui-col-md3">
        <div class="layui-btn-group" style="float:right">
            <button class="layui-btn" id="add">增加</button>
            <button class="layui-btn ">删除</button>
        </div>
    </div>
</div>
<table class="layui-table" id="LAY_table_productSku" lay-data="{height: 'full-40', cellMinWidth: 80, page:true, id:'id'}" lay-filter="productSku">
</table>
<script type="text/html" id="handlebar">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<script>
    layui.use(['element', 'layer', 'form', 'laydate','table'], function() {
        var element = layui.element;
        var $ = layui.jquery, layer = layui.layer;
        var laydate = layui.laydate;
        var table = layui.table;
        var form = layui.form;
        layerTips = parent.layer === undefined ? layui.layer : parent.layer, //获取父窗口的layer对象
        layui.use('table', function () {
            var table = layui.table;
            //监听工具条
            table.on('tool(productSku)', function (obj) {
                var data = obj.data;
                if (obj.event === 'detail') {
                    layer.msg('ID：' + data.id + ' 的查看操作');
                } else if (obj.event === 'del') {
                    layer.confirm('确认删除'+ data.channelName +'渠道吗？', function(index){
                        layer.close(index);
                        $.ajax({
                            url: '${ctx}/channel/channel/channelDelete.do',
                            type: 'post',
                            data:{"id":data.id},
                            dataType: 'json',
                            success:function(data){
                                if(data.success){
                                    layer.msg(data.msg);
                                    reload_table();
                                }else{
                                    layer.msg(data.msg);
                                }
                            }
                        });
                    });;
                } else if (obj.event === 'edit') {
                    update_channel("edit",data.id)
                }
            });
        });

        $("#searchBtn").click(function () {
            reload_table()
        })
        var array = [
            {checkbox: true, fixed: true}
            ,{ title: '序号', type:"numbers"}
            ,{field:'channelName', title: '渠道名称'}
            ,{field:'linkman', title: '负责人'}
            ,{field:'linkMobile', title: '负责人电话'}
            ,{field:'settlementName', title: '结算方式'}
            ,{field:'updateTime', title: '修改时间'}
            ,{toolbar: '#handlebar', title: '操作'}
        ];
        //方法级渲染
        table.render({
            elem: '#LAY_table_productSku'
            ,url: '${ctx}/channel/channel/channelList.json'
            ,cols: [array]
            ,id: 'testReload'
            ,page: true
            ,height: 'full-85'
        });
        function reload_table(){
            var channelName = $('#channelName');
            //执行重载
            table.reload('testReload', {
                page: {
                    curr: 1 //重新从第 1 页开始
                }
                ,where: {
                    se_channelName: channelName.val()
                }
            });
        };

        var addBoxIndex = -1;
        $('#add').on('click', function() {
            update_channel("add")
        })

        function update_channel(type,id){
            if(addBoxIndex !== -1)
                return;
            //本表单通过ajax加载 --以模板的形式，当然你也可以直接写在页面上读取
            url = baseUrl+'/product/productSkuDetail.html';
            $.get(url, null, function(form) {
                addBoxIndex = layer.open({
                    type: 1,
                    title: '新增商品',
                    content: form,
                    btn: ['保存', '取消'],
                    shade:[0.8, '#393D49'],
                    offset: '100px',
                    area: ['600px', '400px'],
                    maxmin: true,
                    yes: function(index) {
                        //触发表单的提交事件
                        $('form.layui-form').find('button[lay-filter=update]').click();
                    },
                    full: function(elem) {
                        var win = window.top === window.self ? window : parent.window;
                        $(win).on('resize', function() {
                            var $this = $(this);
                            elem.width($this.width()).height($this.height()).css({
                                top: 0,
                                left: 0
                            });
                            elem.children('div.layui-layer-content').height($this.height() - 95);
                        });
                    },
                    success: function(layero, index) {
                        var form = layui.form;
                        form.render();
                        form.on('submit(update)', function(data) {
                            $.ajax({
                                url: '${ctx}/channel/channel/channelUpdate.do',
                                type: 'post',
                                data:data.field,
                                dataType: 'json',
                                success:function(data){
                                    if(data.success){
                                        layerTips.msg(data.msg);
                                        location.reload(); //刷新
                                    }else{
                                        layerTips.msg(data.msg);
                                    }
                                }
                            });
                            return false;
                        });
                    }
                });
            });
        }
    });
</script>
</body>
</html>
